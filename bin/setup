#!/bin/bash

trap "exit" INT

docker-compose ${DOCKER_COMPOSER_FILES} kill
docker-compose ${DOCKER_COMPOSER_FILES} rm -f
docker-compose ${DOCKER_COMPOSER_FILES} build
docker-compose ${DOCKER_COMPOSER_FILES} up -d

sleep 2

while ! nc -z localhost 7777; do
    echo "Waiting until DB is fully running..."
    sleep 1
done

mysql -u root -proot -h 127.0.0.1 -P 7777 -e "CREATE DATABASE project"
mysql -u root -proot -h 127.0.0.1 -P 7777 -e "GRANT ALL PRIVILEGES ON project.* TO 'root'@'127.0.0.1' IDENTIFIED BY 'root'"

docker exec -it tests_phpfpm_1 ant